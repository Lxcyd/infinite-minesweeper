<!DOCTYPE html>
<html lang="fr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>D√©mineur Infini</title> 
<link rel="icon" type="image/svg+xml" href="data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'%3E%3Crect width='100' height='100' fill='%230a0e1a' rx='20'/%3E%3Cdefs%3E%3ClinearGradient id='g' x1='0' y1='0' x2='1' y2='1'%3E%3Cstop offset='0' style='stop-color:%2300d4ff'/%3E%3Cstop offset='1' style='stop-color:%2300d4ff'/%3E%3C/linearGradient%3E%3C/defs%3E%3Cpath d='M 25 50 C 25 35, 35 35, 40 40 C 45 45, 45 50, 50 50 C 55 50, 55 45, 60 40 C 65 35, 75 35, 75 50 C 75 65, 65 65, 60 60 C 55 55, 55 50, 50 50 C 45 50, 45 55, 40 60 C 35 65, 25 65, 25 50 Z' fill='none' stroke='url(%23g)' stroke-width='6' stroke-linecap='round' stroke-linejoin='round'/%3E%3C/svg%3E">
<script type="module" src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.esm.js"></script>
<script nomodule src="https://unpkg.com/ionicons@7.1.0/dist/ionicons/ionicons.js"></script>
<style>
@import url('https://fonts.googleapis.com/css2?family=Sora:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;600&display=swap');

*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --bg-main: #080c18;
  --bg-panel: rgba(14, 18, 32, 0.95);
  --bg-card: rgba(22, 28, 46, 0.95);
  --accent-primary: #00d4ff;
  --accent-secondary: #ff2d6b;
  --accent-success: #00ffaa;
  --text-primary: #f0f4ff;
  --text-secondary: #7888a8;
  --border: rgba(255, 255, 255, 0.08);
  --border-hover: rgba(0, 212, 255, 0.35);
  --shadow: 0 12px 40px rgba(0, 0, 0, 0.55);
  --sidebar-w: 340px;
  --sidebar-t: 0.38s cubic-bezier(0.4, 0, 0.2, 1);
  --header-h: 0px;
}

html, body { width: 100%; height: 100%; overflow: hidden; background: var(--bg-main); font-family: 'Sora', sans-serif; color: var(--text-primary); }
#bg-canvas { position: fixed; inset: 0; z-index: 0; opacity: 0.22; pointer-events: none; }
#app { position: fixed; inset: 0; display: flex; flex-direction: column; z-index: 1; }

/* HEADER */
#header {
  flex: 0 0 auto; backdrop-filter: blur(24px); background: var(--bg-panel);
  border-bottom: 1px solid var(--border); padding: 11px 20px;
  display: flex; align-items: center; gap: 14px; box-shadow: var(--shadow); z-index: 100;
  position: relative;
}
#logo { display: flex; align-items: center; gap: 10px; font-size: 17px; font-weight: 700; letter-spacing: -0.4px; white-space: nowrap; }
#logo-icon {
  width: 34px; height: 34px; display: flex; align-items: center; justify-content: center;
  background: linear-gradient(135deg, rgba(0,212,255,0.12), rgba(255,45,107,0.12));
  border: 1px solid rgba(0,212,255,0.28); border-radius: 10px; flex-shrink: 0;
}
#logo-icon ion-icon { font-size: 22px; color: var(--accent-primary); filter: drop-shadow(0 0 6px rgba(0,212,255,0.7)); }

.header-stats { display: flex; gap: 10px; margin-left: auto; }
.stat-card {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 11px;
  padding: 6px 13px; display: flex; flex-direction: column; gap: 1px; min-width: 78px;
  transition: border-color 0.2s, transform 0.2s; align-items: center;
}
.stat-card:hover { transform: translateY(-2px); border-color: var(--border-hover); }
.stat-label { font-size: 9px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.8px; color: var(--text-secondary); }
.stat-value {
  font-family: 'JetBrains Mono', monospace; font-size: 19px; font-weight: 600;
  color: var(--accent-primary);
}
.stat-value.gradient {
  background: linear-gradient(135deg, var(--accent-primary), var(--accent-secondary));
  -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;
}

.btn-group { display: flex; gap: 7px; }
.btn {
  background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px;
  padding: 8px 13px; font-family: 'Sora', sans-serif; font-size: 13px; font-weight: 600;
  color: var(--text-primary); cursor: pointer; display: flex; align-items: center; gap: 6px;
  white-space: nowrap; transition: background 0.2s, border-color 0.2s, transform 0.15s, box-shadow 0.2s;
}
.btn:hover { background: rgba(40,48,72,0.95); border-color: var(--border-hover); transform: translateY(-1px); box-shadow: 0 4px 14px rgba(0,212,255,0.12); }
.btn:active { transform: translateY(0); }
.btn-primary { background: linear-gradient(135deg,#00b8d9,#0086b3); border: none; box-shadow: 0 4px 16px rgba(0,212,255,0.28); color:#fff; }
.btn-primary:hover { box-shadow: 0 6px 22px rgba(0,212,255,0.42); transform: translateY(-2px); background: linear-gradient(135deg,#00d4ff,#0099cc); }
.btn-danger { background: rgba(255,45,107,0.12); border-color: rgba(255,45,107,0.3); color: #ff7aaa; }
.btn-danger:hover { border-color: rgba(255,45,107,0.55); box-shadow: 0 4px 14px rgba(255,45,107,0.2); }
.btn ion-icon { font-size: 16px; flex-shrink: 0; pointer-events: none; }
.btn-small { padding: 8px 12px; font-size: 12px; }
.btn-icon-only { padding: 8px; }

/* GAME AREA */
#game-container { flex: 1 1 0; display: flex; min-height: 0; position: relative; overflow: hidden; }
#canvas-wrap { flex: 1 1 100%; position: relative; overflow: hidden; cursor: crosshair; }
#canvas { display: block; image-rendering: pixelated; image-rendering: crisp-edges; }
#canvas.panning { cursor: grab; }

/* ZOOM CONTROLS - LEFT SIDE */
#zoom-controls {
  position: absolute; bottom: 20px; left: 20px; z-index: 20;
  display: flex; flex-direction: column; gap: 5px;
}
.zoom-btn {
  width: 40px; height: 40px; background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 9px; color: var(--text-primary); font-size: 20px; cursor: pointer;
  display: flex; align-items: center; justify-content: center; backdrop-filter: blur(12px);
  transition: background 0.2s, border-color 0.2s, transform 0.15s, box-shadow 0.2s; user-select: none; line-height: 1;
}
.zoom-btn:hover { background: rgba(40,48,72,0.95); border-color: var(--border-hover); transform: scale(1.08); box-shadow: 0 4px 14px rgba(0,212,255,0.18); }
.zoom-btn:active { transform: scale(0.96); }
.zoom-btn ion-icon { font-size: 20px; }
#zoom-reset-btn { font-size: 11px; font-family: 'JetBrains Mono', monospace; font-weight: 600; color: var(--text-secondary); }

/* SIDEBAR (desktop) - OVERLAY MODE */
#sidebar {
  position: fixed; right: 0; bottom: 0; width: var(--sidebar-w);
  backdrop-filter: blur(24px); background: var(--bg-panel); border-left: 1px solid var(--border);
  display: flex; flex-direction: column; overflow: hidden;
  transition: transform var(--sidebar-t), opacity var(--sidebar-t);
  box-shadow: -6px 0 28px rgba(0,0,0,0.28); z-index: 50;
  transform: translateX(0);
  opacity: 1;
  top: var(--header-h);
}
#sidebar.collapsed { transform: translateX(100%); opacity: 0; pointer-events: none; }
#sidebar-inner { width: 100%; padding: 18px; overflow-y: auto; overflow-x: hidden; display: flex; flex-direction: column; gap: 20px; flex: 1; }
#sidebar-header { display: flex; align-items: center; justify-content: space-between; margin-bottom: 4px; }
#sidebar-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 1.2px; color: var(--text-secondary); }
#sidebar-x { width: 27px; height: 27px; background: rgba(255,45,107,0.1); border: 1px solid rgba(255,45,107,0.22); border-radius: 7px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-secondary); font-size: 15px; transition: background 0.2s, transform 0.15s; }
#sidebar-x:hover { background: rgba(255,45,107,0.22); transform: scale(1.1); }

/* MOBILE PARAMS SHEET */
#mobile-sheet-overlay {
  display: none; position: fixed; inset: 0; z-index: 150;
  background: rgba(0,0,0,0.74); backdrop-filter: blur(8px);
  align-items: flex-end; justify-content: center;
}
#mobile-sheet-overlay.show { display: flex; animation: fadeIn 0.2s ease; }
#mobile-sheet {
  width: 100%; max-width: 540px; max-height: 91vh;
  background: var(--bg-panel); border: 1px solid var(--border); border-bottom: none;
  border-radius: 20px 20px 0 0; overflow: hidden; display: flex; flex-direction: column;
  animation: slideUp 0.3s cubic-bezier(0.34,1.56,0.64,1);
}
#mobile-sheet-top { display: flex; align-items: center; justify-content: space-between; padding: 15px 18px 12px; border-bottom: 1px solid var(--border); flex-shrink: 0; }
#mobile-sheet-title { font-size: 16px; font-weight: 700; }
#mobile-sheet-close { width: 30px; height: 30px; background: rgba(255,45,107,0.1); border: 1px solid rgba(255,45,107,0.22); border-radius: 8px; cursor: pointer; display: flex; align-items: center; justify-content: center; color: var(--accent-secondary); font-size: 17px; transition: background 0.2s, transform 0.15s; }
#mobile-sheet-close:hover { background: rgba(255,45,107,0.22); transform: scale(1.08); }
#mobile-sheet-body { overflow-y: auto; padding: 18px; display: flex; flex-direction: column; gap: 20px; }

/* SHARED PANEL STYLES */
.panel { background: var(--bg-card); border: 1px solid var(--border); border-radius: 13px; padding: 16px; transition: border-color 0.2s; margin-bottom: 16px; }
.panel:hover { border-color: rgba(255,255,255,0.12); }
.panel-title { font-size: 11px; font-weight: 700; text-transform: uppercase; letter-spacing: 0.7px; color: var(--text-secondary); margin-bottom: 14px; display: flex; align-items: center; gap: 7px; }
.panel-icon { font-size: 14px; }
.input-group { display: flex; flex-direction: column; gap: 6px; margin-bottom: 9px; }
.input-group label { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
.input-group input { background: rgba(8,12,24,0.7); border: 1px solid var(--border); border-radius: 7px; padding: 8px 11px; font-family: 'JetBrains Mono', monospace; font-size: 13px; color: var(--text-primary); width: 100%; transition: border-color 0.2s, box-shadow 0.2s; }
.input-group input:focus { outline: none; border-color: var(--accent-primary); box-shadow: 0 0 0 3px rgba(0,212,255,0.1); }
.input-group input::placeholder { color: var(--text-secondary); opacity: 0.4; }
.help-text { font-size: 11px; color: var(--text-secondary); line-height: 1.6; margin-top: 7px; }
.shortcut-list { display: flex; flex-direction: column; gap: 5px; }
.shortcut-item { display: flex; justify-content: space-between; align-items: center; padding: 6px 9px; background: rgba(8,12,24,0.4); border-radius: 6px; font-size: 11px; color: var(--text-secondary); }
.shortcut-item span:first-child { color: var(--text-primary); }
.shortcut-key { background: rgba(255,255,255,0.06); border: 1px solid rgba(255,255,255,0.1); padding: 2px 6px; border-radius: 4px; font-family: 'JetBrains Mono', monospace; font-size: 10px; font-weight: 600; color: var(--accent-primary); }
.tip-box { font-size: 11px; color: var(--text-secondary); line-height: 1.7; padding: 12px; background: rgba(0,212,255,0.05); border-radius: 9px; border: 1px solid rgba(0,212,255,0.14); }
.tip-box strong { color: var(--accent-primary); }
.row-btns { display: flex; gap: 8px; }
.row-btns .btn { flex: 1; justify-content: center; }

/* TOGGLE SWITCH */
.toggle-group { display: flex; justify-content: space-between; align-items: center; margin-bottom: 9px; }
.toggle-group label { font-size: 12px; font-weight: 500; color: var(--text-secondary); }
.toggle-switch { position: relative; display: inline-block; width: 46px; height: 24px; }
.toggle-switch input { opacity: 0; width: 0; height: 0; }
.toggle-slider {
  position: absolute; cursor: pointer; top: 0; left: 0; right: 0; bottom: 0;
  background: rgba(255,255,255,0.1); border: 1px solid var(--border); border-radius: 24px;
  transition: 0.3s;
}
.toggle-slider:before {
  position: absolute; content: ""; height: 16px; width: 16px; left: 3px; bottom: 3px;
  background: var(--text-secondary); border-radius: 50%; transition: 0.3s;
}
input:checked + .toggle-slider { background: var(--accent-primary); border-color: var(--accent-primary); }
input:checked + .toggle-slider:before { transform: translateX(22px); background: white; }

/* MOBILE CONTROLS */
#mobile-controls { display: none; position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); z-index: 50; gap: 14px; }
.mobile-mode-btn { width: 62px; height: 62px; backdrop-filter: blur(20px); background: var(--bg-card); border: 2px solid var(--border); border-radius: 50%; font-size: 26px; display: flex; align-items: center; justify-content: center; cursor: pointer; transition: all 0.22s ease; box-shadow: 0 8px 24px rgba(0,0,0,0.4); }
.mobile-mode-btn:active { transform: scale(0.93); }
.mobile-mode-btn.active { border-color: var(--accent-primary); background: rgba(0,212,255,0.13); box-shadow: 0 0 20px rgba(0,212,255,0.38); }

/* MODAL */
#modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.8); backdrop-filter: blur(10px); z-index: 250; align-items: center; justify-content: center; }
#modal-overlay.show { display: flex; animation: fadeIn 0.22s ease; }
.modal { background: var(--bg-card); border: 1px solid var(--border); border-radius: 20px; padding: 38px 34px 34px; max-width: 450px; width: 92%; text-align: center; box-shadow: 0 24px 64px rgba(0,0,0,0.65); animation: slideUp 0.28s cubic-bezier(0.34,1.56,0.64,1); }
.modal-icon { font-size: 58px; margin-bottom: 14px; }
.modal-title { font-size: 24px; font-weight: 700; margin-bottom: 9px; background: linear-gradient(135deg,var(--accent-primary),var(--accent-secondary)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text; }
.modal-text { font-size: 14px; color: var(--text-secondary); margin-bottom: 10px; line-height: 1.65; }
.modal-warning { font-size: 12px; color: #ffaa55; background: rgba(255,170,85,0.1); border: 1px solid rgba(255,170,85,0.28); border-radius: 8px; padding: 10px 13px; margin-bottom: 22px; line-height: 1.55; text-align: left; }
.modal-actions { display: flex; gap: 9px; justify-content: center; flex-wrap: wrap; }

/* TOAST */
#toast-container { position: fixed; top: 70px; right: 18px; z-index: 300; display: flex; flex-direction: column; gap: 8px; pointer-events: none; }
.toast { background: var(--bg-card); border: 1px solid var(--border); border-radius: 10px; padding: 11px 15px; display: flex; align-items: center; gap: 10px; box-shadow: var(--shadow); pointer-events: all; min-width: 230px; transition: opacity 0.3s, transform 0.3s; animation: slideInRight 0.28s cubic-bezier(0.34,1.56,0.64,1); }
.toast-icon { font-size: 20px; flex-shrink: 0; }
.toast-content { flex: 1; }
.toast-title { font-size: 12px; font-weight: 600; margin-bottom: 1px; }
.toast-message { font-size: 11px; color: var(--text-secondary); }
.toast.success { border-left: 3px solid var(--accent-success); }
.toast.success .toast-icon { color: var(--accent-success); }
.toast.error { border-left: 3px solid var(--accent-secondary); }
.toast.error .toast-icon { color: var(--accent-secondary); }
.toast.info { border-left: 3px solid var(--accent-primary); }
.toast.info .toast-icon { color: var(--accent-primary); }

@keyframes fadeIn { from { opacity:0; } to { opacity:1; } }
@keyframes slideUp { from { opacity:0; transform:translateY(26px) scale(0.96); } to { opacity:1; transform:translateY(0) scale(1); } }
@keyframes slideInRight { from { opacity:0; transform:translateX(100%); } to { opacity:1; transform:translateX(0); } }

/* RESPONSIVE */
@media (max-width: 768px) {
  #header { flex-wrap: wrap; padding: 9px 13px; gap: 9px; }
  #logo { font-size: 15px; }
  #logo-icon { width: 30px; height: 30px; }
  #logo-icon ion-icon { font-size: 18px; }
  
  .btn-group { width: auto; margin-left: auto; }
  .btn-group .btn:not(#btn-mobile-params) { display: none !important; }
  
  .header-stats { order: 3; width: 100%; justify-content: space-between; gap: 6px; }
  .stat-card { min-width: auto; flex: 1; padding: 5px 10px; }
  .stat-label { font-size: 8px; }
  .stat-value { font-size: 16px; }
  
  #sidebar { display: none !important; }
  #btn-desktop-params { display: none !important; }
  #mobile-controls { display: flex; }
  #toast-container { right: 10px; left: 10px; top: auto; bottom: 150px; }
  .toast { min-width: auto; }
  
  #zoom-controls { bottom: 20px; left: 14px; flex-direction: column; }
  .zoom-btn { width: 44px; height: 44px; }
  #fullscreen-btn { display: none !important; }
}
@media (min-width: 769px) {
  #btn-mobile-params { display: none !important; }
}

::-webkit-scrollbar { width: 5px; }
::-webkit-scrollbar-track { background: transparent; }
::-webkit-scrollbar-thumb { background: rgba(255,255,255,0.1); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: rgba(255,255,255,0.18); }
</style>
</head>
<body>

<canvas id="bg-canvas"></canvas>
<div id="toast-container"></div>

<!-- MAIN MODAL -->
<div id="modal-overlay">
  <div class="modal">
    <div class="modal-icon" id="modal-icon">‚ö†Ô∏è</div>
    <div class="modal-title" id="modal-title"></div>
    <div class="modal-text" id="modal-text"></div>
    <div class="modal-warning" id="modal-warning" style="display:none;"></div>
    <div class="modal-actions" id="modal-actions"></div>
  </div>
</div>

<!-- MOBILE PARAMS SHEET -->
<div id="mobile-sheet-overlay">
  <div id="mobile-sheet">
    <div id="mobile-sheet-top">
      <span id="mobile-sheet-title">Param√®tres</span>
      <button id="mobile-sheet-close">‚úï</button>
    </div>
    <div id="mobile-sheet-body"></div>
  </div>
</div>

<div id="app">
  <div id="header">
    <div id="logo">
      <div id="logo-icon"><ion-icon name="infinite"></ion-icon></div>
      <span>D√©mineur Infini</span>
    </div>

    <div class="btn-group">
      <button class="btn btn-primary" id="new-game-btn" title="Ctrl+N">
        <ion-icon name="refresh-outline"></ion-icon> Nouveau
      </button>
      <button class="btn" id="save-btn" title="Ctrl+S">
        <ion-icon name="save-outline"></ion-icon> Sauvegarder
      </button>
      <button class="btn" id="export-btn">
        <ion-icon name="share-outline"></ion-icon> Export
      </button>
      <button class="btn" id="btn-desktop-params" title="Param√®tres">
        <ion-icon name="settings-outline"></ion-icon> Param√®tres
      </button>
      <button class="btn btn-icon-only" id="btn-mobile-params" title="Param√®tres">
        <ion-icon name="settings-outline"></ion-icon>
      </button>
    </div>

    <div class="header-stats">
      <div class="stat-card"><div class="stat-label">Drapeaux</div><div class="stat-value" id="flag-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Erreurs</div><div class="stat-value" id="error-count">0</div></div>
      <div class="stat-card"><div class="stat-label">Cases</div><div class="stat-value gradient" id="revealed-count">0</div></div>
    </div>
  </div>

  <div id="game-container">
    <div id="canvas-wrap">
      <canvas id="canvas"></canvas>

      <div id="zoom-controls">
        <button class="zoom-btn" id="zoom-in-btn" title="Zoom +"><ion-icon name="add-outline"></ion-icon></button>
        <button class="zoom-btn" id="zoom-reset-btn" title="R√©initialiser zoom">100%</button>
        <button class="zoom-btn" id="zoom-out-btn" title="Zoom ‚àí"><ion-icon name="remove-outline"></ion-icon></button>
        <button class="zoom-btn" id="fullscreen-btn" title="Plein √©cran"><ion-icon name="expand-outline"></ion-icon></button>
      </div>
    </div>

    <div id="mobile-controls">
      <button class="mobile-mode-btn" id="mobile-reveal">üí°</button>
      <button class="mobile-mode-btn" id="mobile-flag">üö©</button>
    </div>

    <div id="sidebar" class="collapsed">
      <div id="sidebar-inner">
        <div id="sidebar-header">
          <span id="sidebar-title">Param√®tres</span>
          <button id="sidebar-x">‚úï</button>
        </div>
        <div id="sidebar-content"></div>
      </div>
    </div>
  </div>
</div>

<script>
const CONFIG = {
  BASE_CELL: 24, MINE_PCT: 18, SAFE_RADIUS: 4,
  MAX_FLOOD: 30000,
  ZOOM_MIN: 0.05, ZOOM_MAX: 5, ZOOM_TEX: 0.4,
  AUTO_SAVE: 10000, CULL: 2,
};

const COLORS = {
  nums: [null,'#4fc3f7','#81c784','#e57373','#ba68c8','#ffb74d','#26c6da','#a1887f','#90a4ae'],
  revealed: '#1a2035', hidden: '#2d3655', border: '#0d1120', blight: '#4a5280',
  mine: '#ff2d6b', mineOld: '#3a3e56',
};

// DOM
const canvas = document.getElementById('canvas');
const ctx = canvas.getContext('2d', { alpha: false, desynchronized: true });
const bgCanvas = document.getElementById('bg-canvas');
const bgCtx = bgCanvas.getContext('2d');
const flagEl = document.getElementById('flag-count');
const errorEl = document.getElementById('error-count');
const revEl = document.getElementById('revealed-count');
const canvasWrap = document.getElementById('canvas-wrap');
const toastCont = document.getElementById('toast-container');
const sidebar = document.getElementById('sidebar');
const modalOverlay = document.getElementById('modal-overlay');
const mobileSheetOverlay = document.getElementById('mobile-sheet-overlay');

// STATE
let G = {
  seed: '', rng: null,
  revealed: new Set(), flagged: new Set(), safeCells: new Set(),
  preRevealedMines: new Set(),
  gameOver: false, firstClick: true, firstError: true,
  mineHit: null, errorCount: 0, revealedCount: 0,
  mobileMode: 'neutral', // 'reveal', 'flag', or 'neutral'
};
let V = {
  W: 0, H: 0, offX: 0, offY: 0, zoom: 1,
  panning: false, panSX: 0, panSY: 0, panOX: 0, panOY: 0,
  didPan: false, hover: null, dirty: true,
  mouseDownTime: 0, mouseDownX: 0, mouseDownY: 0,
};
let SETTINGS = {
  notifications: true,
  autoSave: true,
  noExplosionDelay: false,
};

// RNG
class RNG {
  constructor(s) { this.state = this._hash(s); }
  _hash(s) { let h=0; for(let i=0;i<s.length;i++) h=Math.imul(31,h)+s.charCodeAt(i)|0; return h>>>0; }
  xy(x,y) { let h=Math.imul(x|0,0x9e3779b9)^Math.imul(y|0,0x6c62272e); h^=this.state; h^=h>>>16; h=Math.imul(h,0x45d9f3b); h^=h>>>16; return (h>>>0)%100; }
}

const key = (x,y) => `${x},${y}`;
const cs = () => CONFIG.BASE_CELL * V.zoom;

function hasMine(x,y) {
  if (!G.rng) return false;
  if (G.safeCells.has(key(x,y))) return false;
  return G.rng.xy(x,y) < CONFIG.MINE_PCT;
}
function countMines(x,y) {
  let c=0;
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) if((dx||dy)&&hasMine(x+dx,y+dy)) c++;
  return c;
}
function s2c(sx,sy) { const c=cs(); return [Math.floor((sx-V.offX)/c), Math.floor((sy-V.offY)/c)]; }
function c2s(cx,cy) { const c=cs(); return [cx*c+V.offX, cy*c+V.offY]; }
function randSeed() { const c='abcdefghijklmnopqrstuvwxyz0123456789'; return Array.from({length:12},()=>c[Math.floor(Math.random()*c.length)]).join(''); }

function safeZone(ox,oy) {
  G.safeCells.clear();
  for(let dy=-CONFIG.SAFE_RADIUS;dy<=CONFIG.SAFE_RADIUS;dy++)
    for(let dx=-CONFIG.SAFE_RADIUS;dx<=CONFIG.SAFE_RADIUS;dx++) G.safeCells.add(key(ox+dx,oy+dy));
}

function reveal(x,y) {
  if (G.gameOver) return;
  const k=key(x,y);
  if (G.revealed.has(k)) { chord(x,y); return; }
  if (G.flagged.has(k)) return;
  if (G.firstClick) { safeZone(x,y); G.firstClick=false; }
  if (hasMine(x,y)) {
    G.revealed.add(k); G.revealedCount++; G.gameOver=true; G.mineHit=[x,y]; G.errorCount++;
    if(G.firstError) showErrorModal();
    updateUI(); dirty();
    const delay = SETTINGS.noExplosionDelay ? 0 : 800;
    setTimeout(() => continueAfterError(), delay);
    return;
  }
  const q=[[x,y]], seen=new Set([k]); let cnt=0;
  while(q.length && cnt<CONFIG.MAX_FLOOD) {
    const [cx,cy]=q.shift(), ck=key(cx,cy);
    if (!G.revealed.has(ck)) { G.revealed.add(ck); G.revealedCount++; cnt++; }
    if (!countMines(cx,cy)) {
      for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) {
        if(!dx&&!dy) continue;
        const nk=key(cx+dx,cy+dy);
        if(!seen.has(nk)&&!hasMine(cx+dx,cy+dy)&&!G.flagged.has(nk)) { seen.add(nk); q.push([cx+dx,cy+dy]); }
      }
    }
  }
  updateUI(); dirty();
}

function chord(x,y) {
  const k=key(x,y); if(!G.revealed.has(k)||hasMine(x,y)) return;
  const mc=countMines(x,y); if(!mc) return;
  let fc=0;
  for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) if((dx||dy)&&G.flagged.has(key(x+dx,y+dy))) fc++;
  if(fc===mc) { for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) { if(!dx&&!dy) continue; const nk=key(x+dx,y+dy); if(!G.revealed.has(nk)&&!G.flagged.has(nk)) reveal(x+dx,y+dy); } }
}

function flag(x,y) {
  if(G.gameOver) return; const k=key(x,y); if(G.revealed.has(k)) return;
  if(G.flagged.has(k)) G.flagged.delete(k); else G.flagged.add(k);
  updateUI(); dirty();
}

// RENDER
let rq=false;
function dirty() { V.dirty=true; if(!rq){rq=true; requestAnimationFrame(()=>{render();rq=false;});} }

function render() {
  if(!V.dirty) return;
  const c=cs(), {W,H,offX,offY}=V;
  ctx.fillStyle=COLORS.border; ctx.fillRect(0,0,W,H);
  const m=CONFIG.CULL;
  const x0=Math.floor(-offX/c)-m, y0=Math.floor(-offY/c)-m;
  const x1=Math.ceil((W-offX)/c)+m, y1=Math.ceil((H-offY)/c)+m;
  const tex = V.zoom < CONFIG.ZOOM_TEX;
  
  // Clipper le rendu √† la zone visible
  ctx.save();
  ctx.beginPath();
  ctx.rect(0, 0, W, H);
  ctx.clip();
  
  if(tex) {
    ctx.fillStyle=COLORS.hidden; ctx.fillRect(0,0,W,H);
    for(let cy=y0;cy<=y1;cy++) for(let cx=x0;cx<=x1;cx++) { const k=key(cx,cy); if(G.revealed.has(k)||G.flagged.has(k)) drawCell(cx,cy,c); }
  } else {
    for(let cy=y0;cy<=y1;cy++) for(let cx=x0;cx<=x1;cx++) drawCell(cx,cy,c);
  }
  
  ctx.restore();
  
  if(V.hover&&!G.gameOver&&!tex) {
    const[hx,hy]=V.hover,[sx,sy]=c2s(hx,hy);
    ctx.strokeStyle='rgba(0,212,255,0.42)'; ctx.lineWidth=Math.max(2,c*0.07);
    ctx.strokeRect(sx+1,sy+1,c-2,c-2);
  }
  V.dirty=false;
}

function drawCell(cx,cy,c) {
  const k=key(cx,cy),[sx,sy]=c2s(cx,cy);
  if(sx+c<0||sx>V.W||sy+c<0||sy>V.H) return;
  const rev=G.revealed.has(k), fl=G.flagged.has(k);
  const mine=hasMine(cx,cy), hit=G.mineHit&&G.mineHit[0]===cx&&G.mineHit[1]===cy;
  if(rev) drawRev(sx,sy,c,mine,hit,cx,cy); else drawHid(sx,sy,c,fl);
}

function drawHid(sx,sy,c,fl) {
  const p=Math.max(1,c*0.04);
  ctx.fillStyle=COLORS.hidden; ctx.fillRect(sx+p,sy+p,c-p*2,c-p*2);
  ctx.fillStyle=COLORS.blight; const hl=Math.max(1,c*0.08);
  ctx.fillRect(sx+p,sy+p,c-p*2,hl); ctx.fillRect(sx+p,sy+p,hl,c-p*2);
  if(fl) drawFlag(sx,sy,c);
}

function drawRev(sx,sy,c,mine,hit,cx,cy) {
  const p=Math.max(1,c*0.04);
  ctx.fillStyle=hit?'#3d0012':COLORS.revealed; ctx.fillRect(sx+p,sy+p,c-p*2,c-p*2);
  if(hit) { ctx.fillStyle='rgba(255,45,107,0.18)'; ctx.fillRect(sx+p,sy+p,c-p*2,c-p*2); }
  if(mine) drawMine(sx,sy,c,hit,cx,cy); else { const n=countMines(cx,cy); if(n) drawNum(sx,sy,c,n); }
}

function drawFlag(sx,sy,c) {
  const cx=sx+c/2,cy=sy+c/2,s=c*0.28;
  const pW=Math.max(1.5,c*0.065),pTop=cy-s*1.0,pBot=cy+s*1.2;
  ctx.save(); ctx.shadowColor='rgba(0,0,0,0.38)'; ctx.shadowBlur=c*0.14;
  ctx.fillStyle='#4a5280'; ctx.beginPath(); ctx.ellipse(cx,pBot,s*0.65,s*0.18,0,0,Math.PI*2); ctx.fill();
  const pg=ctx.createLinearGradient(cx,0,cx+pW*3,0);
  pg.addColorStop(0,'#6a7090'); pg.addColorStop(1,'#b0b8d0'); ctx.fillStyle=pg;
  ctx.beginPath();
  if(ctx.roundRect) ctx.roundRect(cx-pW/2,pTop,pW,pBot-pTop,pW/2); else ctx.rect(cx-pW/2,pTop,pW,pBot-pTop);
  ctx.fill();
  const fg=ctx.createLinearGradient(cx,pTop,cx+s*1.5,pTop+s*0.9);
  fg.addColorStop(0,'#ff2d6b'); fg.addColorStop(1,'#ff7a2d'); ctx.fillStyle=fg;
  ctx.beginPath(); ctx.moveTo(cx,pTop); ctx.lineTo(cx+s*1.5,pTop+s*0.55); ctx.lineTo(cx,pTop+s*1.1); ctx.closePath(); ctx.fill();
  ctx.fillStyle='rgba(255,255,255,0.18)';
  ctx.beginPath(); ctx.moveTo(cx,pTop); ctx.lineTo(cx+s*1.5,pTop+s*0.55); ctx.lineTo(cx,pTop+s*0.28); ctx.closePath(); ctx.fill();
  ctx.restore();
}

function drawMine(sx,sy,c,hit,cx,cy) {
  const k=key(cx,cy);
  const isOld = G.preRevealedMines.has(k);
  const mineColor = isOld ? COLORS.mineOld : COLORS.mine;
  
  const centerX=sx+c/2, centerY=sy+c/2, r=c*0.22;
  ctx.save();
  
  if(hit && !isOld) {
    ctx.shadowColor='#ff2d6b'; ctx.shadowBlur=c*0.4;
  } else {
    ctx.shadowColor='rgba(0,0,0,0.5)'; ctx.shadowBlur=c*0.2;
  }
  
  const bg=ctx.createRadialGradient(centerX-r*0.3,centerY-r*0.3,r*0.1,centerX,centerY,r);
  if(isOld) {
    bg.addColorStop(0,'#5a5e76'); bg.addColorStop(1,'#2a2e3e');
  } else if(hit) {
    bg.addColorStop(0,'#ff6b8a'); bg.addColorStop(1,'#cc0033');
  } else {
    bg.addColorStop(0,'#ff5577'); bg.addColorStop(1,mineColor);
  }
  ctx.fillStyle=bg; ctx.beginPath(); ctx.arc(centerX,centerY,r,0,Math.PI*2); ctx.fill();
  
  ctx.strokeStyle=isOld?'#4a4e66':(hit?'#ff2d6b':'#ff3366'); 
  ctx.lineWidth=Math.max(1,c*0.06); ctx.lineCap='round';
  for(let i=0;i<8;i++) { 
    const a=i*Math.PI/4; 
    ctx.beginPath(); 
    ctx.moveTo(centerX+Math.cos(a)*r*0.85,centerY+Math.sin(a)*r*0.85); 
    ctx.lineTo(centerX+Math.cos(a)*r*1.65,centerY+Math.sin(a)*r*1.65); 
    ctx.stroke(); 
  }
  
  if(!isOld) {
    ctx.fillStyle='rgba(255,255,255,0.4)'; 
    ctx.beginPath(); 
    ctx.arc(centerX-r*0.28,centerY-r*0.28,r*0.27,0,Math.PI*2); 
    ctx.fill();
  }
  
  ctx.restore();
}

function drawNum(sx,sy,c,n) {
  ctx.fillStyle=COLORS.nums[n]||'#888';
  ctx.font=`700 ${Math.floor(c*0.62)}px 'JetBrains Mono', monospace`;
  ctx.textAlign='center'; ctx.textBaseline='middle';
  ctx.fillText(n,sx+c/2,sy+c/2+1);
}

// BG ANIMATION
let bgP=[];
function initBg() {
  bgCanvas.width=window.innerWidth; bgCanvas.height=window.innerHeight;
  bgP=Array.from({length:55},()=>({x:Math.random()*bgCanvas.width,y:Math.random()*bgCanvas.height,vx:(Math.random()-0.5)*0.38,vy:(Math.random()-0.5)*0.38,size:Math.random()*1.4+0.4,op:Math.random()*0.32+0.07}));
  animBg();
}
function animBg() {
  bgCtx.fillStyle='rgba(8,12,24,0.12)'; bgCtx.fillRect(0,0,bgCanvas.width,bgCanvas.height);
  bgP.forEach(p=>{p.x+=p.vx;p.y+=p.vy;if(p.x<0||p.x>bgCanvas.width)p.vx*=-1;if(p.y<0||p.y>bgCanvas.height)p.vy*=-1;bgCtx.fillStyle=`rgba(0,212,255,${p.op})`;bgCtx.beginPath();bgCtx.arc(p.x,p.y,p.size,0,Math.PI*2);bgCtx.fill();});
  requestAnimationFrame(animBg);
}

// UI
function updateUI() {
  flagEl.textContent=G.flagged.size; errorEl.textContent=G.errorCount; revEl.textContent=G.revealedCount;
  document.getElementById('zoom-reset-btn').textContent=`${Math.round(V.zoom*100)}%`;
  document.querySelectorAll('.cur-seed').forEach(el=>el.value=G.seed||'');
}

// MODAL
function showModal({icon,title,text,warning,actions}) {
  document.getElementById('modal-icon').textContent=icon||'‚ö†Ô∏è';
  document.getElementById('modal-title').textContent=title;
  document.getElementById('modal-text').textContent=text;
  const w=document.getElementById('modal-warning');
  if(warning){w.textContent=warning;w.style.display='';}else w.style.display='none';
  const a=document.getElementById('modal-actions'); a.innerHTML='';
  (actions||[]).forEach(act=>{
    const b=document.createElement('button'); b.className=`btn ${act.cls||''}`;
    b.innerHTML=act.label;
    b.addEventListener('click',()=>{modalOverlay.classList.remove('show');if(act.fn)act.fn();});
    a.appendChild(b);
  });
  modalOverlay.classList.add('show');
}

function showErrorModal() {
  G.firstError = false;
  showModal({
    icon:'üí•', title:'Premi√®re erreur !',
    text:'Vous avez touch√© une mine. Dans le D√©mineur Infini, chaque mine touch√©e compte comme une erreur.',
    warning:'üí° Le jeu continue automatiquement ! Vous pouvez continuer √† jouer et explorer la carte. Les erreurs sont comptabilis√©es, mais vous ne perdez pas. Utilisez les drapeaux pour marquer les mines suspectes.',
    actions:[
      {label:'<ion-icon name="play-outline"></ion-icon> Continuer',cls:'btn-primary',fn:()=>continueAfterError()},
      {label:'<ion-icon name="refresh-outline"></ion-icon> Recommencer',fn:()=>confirmNewGame()},
    ]
  });
}

function continueAfterError() {
  G.gameOver = false;
  G.mineHit = null;
  dirty();
}

function confirmNewGame() {
  showModal({
    icon:'üîÑ', title:'Nouvelle partie ?',
    text:'Recommencer une nouvelle partie ?',
    warning:'‚ö†Ô∏è Tout votre progr√®s sera perdu (cases r√©v√©l√©es, drapeaux, erreurs).',
    actions:[
      {label:'<ion-icon name="refresh-outline"></ion-icon> Oui, recommencer',cls:'btn-danger',fn:()=>newGame()},
      {label:'<ion-icon name="close-outline"></ion-icon> Annuler',fn:null},
    ]
  });
}

function confirmApplySeed(seed) {
  showModal({
    icon:'üé≤', title:'Appliquer une nouvelle seed ?',
    text:'Cela va d√©marrer une nouvelle partie avec cette seed.',
    warning:'‚ö†Ô∏è Tout votre progr√®s actuel sera perdu (cases r√©v√©l√©es, drapeaux, erreurs).',
    actions:[
      {label:'<ion-icon name="sparkles-outline"></ion-icon> Oui, appliquer',cls:'btn-danger',fn:()=>newGame(seed||null)},
      {label:'<ion-icon name="close-outline"></ion-icon> Annuler',fn:null},
    ]
  });
}

// TOAST
function toast(type,title,msg) {
  if (!SETTINGS.notifications) return;
  const t=document.createElement('div'); t.className=`toast ${type}`;
  let ic;
  if(type==='success') ic='<ion-icon name="checkmark-circle-outline"></ion-icon>';
  else if(type==='error') ic='<ion-icon name="close-circle-outline"></ion-icon>';
  else ic='<ion-icon name="information-circle-outline"></ion-icon>';
  t.innerHTML=`<div class="toast-icon">${ic}</div><div class="toast-content"><div class="toast-title">${title}</div><div class="toast-message">${msg}</div></div>`;
  toastCont.appendChild(t);
  setTimeout(()=>{t.style.opacity='0';t.style.transform='translateX(100%)';setTimeout(()=>t.remove(),300);},3200);
}

// SAVE / LOAD
function saveGame(notify=false) {
  try {
    localStorage.setItem('mine_v4',JSON.stringify({
      seed:G.seed,r:[...G.revealed],f:[...G.flagged],sc:[...G.safeCells],
      fc:G.firstClick,rc:G.revealedCount,ec:G.errorCount,fe:G.firstError,
      prm:[...G.preRevealedMines],
      settings:SETTINGS,ts:Date.now()
    }));
    if(notify) toast('success','Partie sauvegard√©e','Votre progression a √©t√© enregistr√©e');
  } catch { if(notify) toast('error','Erreur','Impossible de sauvegarder'); }
}

function loadGame() {
  try {
    const d=JSON.parse(localStorage.getItem('mine_v4')); if(!d) return false;
    G.seed=d.seed; G.rng=new RNG(d.seed);
    G.revealed=new Set(d.r); G.flagged=new Set(d.f); G.safeCells=new Set(d.sc||[]);
    G.firstClick=d.fc; G.revealedCount=d.rc||d.r.length; 
    G.errorCount=d.ec||0; G.firstError=d.fe!==false;
    G.gameOver=false; G.mineHit=null;
    
    G.preRevealedMines=new Set();
    d.r.forEach(k => {
      const [x,y] = k.split(',').map(Number);
      if(hasMine(x,y)) G.preRevealedMines.add(k);
    });
    
    if(d.settings) SETTINGS={...SETTINGS,...d.settings};
    updateUI(); dirty(); return true;
  } catch { return false; }
}

function exportGame() {
  const data=btoa(JSON.stringify({v:4,s:G.seed,r:[...G.revealed],f:[...G.flagged],sc:[...G.safeCells],ec:G.errorCount}));
  navigator.clipboard.writeText(data)
    .then(()=>toast('success','Code export√© !','Copi√© dans le presse-papier'))
    .catch(()=>toast('error','Erreur clipboard','Impossible de copier automatiquement'));
}

function importGame(code) {
  try {
    const d=JSON.parse(atob(code.trim()));
    if(d.v<1||d.v>4) { toast('error','Version incompatible','Ce code n\'est pas compatible'); return; }
    G.seed=d.s; G.rng=new RNG(d.s);
    G.revealed=new Set(d.r); G.flagged=new Set(d.f);
    if(d.v>=2&&d.sc) {
      G.safeCells=new Set(d.sc);
    } else {
      G.safeCells=new Set();
      d.r.forEach(k=>{ const[x,y]=k.split(',').map(Number); for(let dy=-1;dy<=1;dy++) for(let dx=-1;dx<=1;dx++) G.safeCells.add(key(x+dx,y+dy)); });
    }
    G.firstClick=false; G.revealedCount=d.r.length; G.gameOver=false;
    G.mineHit=null; G.errorCount=d.ec||0; G.firstError=false;
    
    G.preRevealedMines=new Set();
    d.r.forEach(k => {
      const [x,y] = k.split(',').map(Number);
      if(hasMine(x,y)) G.preRevealedMines.add(k);
    });
    
    updateUI(); dirty();
    toast('success','Partie import√©e !','La partie a √©t√© restaur√©e avec succ√®s');
  } catch { toast('error','Code invalide','Le code est invalide ou corrompu'); }
}

function newGame(seed=null) {
  G.seed=seed||randSeed(); G.rng=new RNG(G.seed);
  G.revealed=new Set(); G.flagged=new Set(); G.safeCells=new Set();
  G.gameOver=false; G.firstClick=true; G.mineHit=null;
  G.errorCount=0; G.revealedCount=0; G.firstError=true;
  G.preRevealedMines=new Set();
  V.zoom=1; V.offX=V.W/2-6*CONFIG.BASE_CELL; V.offY=V.H/2-6*CONFIG.BASE_CELL;
  modalOverlay.classList.remove('show'); updateUI(); dirty();
  toast('info','Nouveau jeu !',`Seed : ${G.seed}`);
}

// ZOOM
function zoom(factor,cx,cy) {
  cx=cx??V.W/2; cy=cy??V.H/2;
  const nz=Math.min(CONFIG.ZOOM_MAX,Math.max(CONFIG.ZOOM_MIN,V.zoom*factor));
  const sc=nz/V.zoom;
  V.offX=cx-sc*(cx-V.offX); V.offY=cy-sc*(cy-V.offY); V.zoom=nz;
  updateUI(); dirty();
}

// FULLSCREEN
function toggleFullscreen() {
  if (!document.fullscreenElement) {
    document.documentElement.requestFullscreen().catch(err => {
      toast('error', 'Erreur plein √©cran', 'Impossible d\'activer le mode plein √©cran');
    });
  } else {
    document.exitFullscreen();
  }
}

// EXPORT IMAGE
async function exportImage() {
  toast('info', 'Export en cours...', 'G√©n√©ration de l\'image de la partie');
  
  let minX = Infinity, maxX = -Infinity, minY = Infinity, maxY = -Infinity;
  
  G.revealed.forEach(k => {
    const [x, y] = k.split(',').map(Number);
    minX = Math.min(minX, x); maxX = Math.max(maxX, x);
    minY = Math.min(minY, y); maxY = Math.max(maxY, y);
  });
  
  G.flagged.forEach(k => {
    const [x, y] = k.split(',').map(Number);
    minX = Math.min(minX, x); maxX = Math.max(maxX, x);
    minY = Math.min(minY, y); maxY = Math.max(maxY, y);
  });
  
  if(G.revealed.size === 0 && G.flagged.size === 0) {
    toast('error', 'Aucune case √† exporter', 'R√©v√©lez des cases ou placez des drapeaux avant d\'exporter');
    return;
  }
  
  const margin = 2;
  minX -= margin; maxX += margin; minY -= margin; maxY += margin;
  
  const cellSize = 32;
  const w = (maxX - minX + 1) * cellSize;
  const h = (maxY - minY + 1) * cellSize;
  
  const tempCanvas = document.createElement('canvas');
  tempCanvas.width = w;
  tempCanvas.height = h;
  const c = tempCanvas.getContext('2d');
  
  c.fillStyle = COLORS.border;
  c.fillRect(0, 0, w, h);
  
  for(let cy = minY; cy <= maxY; cy++) {
    for(let cx = minX; cx <= maxX; cx++) {
      const sx = (cx - minX) * cellSize;
      const sy = (cy - minY) * cellSize;
      const k = key(cx, cy);
      const revealed = G.revealed.has(k);
      const flagged = G.flagged.has(k);
      const mine = hasMine(cx, cy);
      const p = Math.max(1, cellSize * 0.04);
      
      if(revealed) {
        c.fillStyle = COLORS.revealed;
        c.fillRect(sx + p, sy + p, cellSize - p * 2, cellSize - p * 2);
        
        if(mine) {
          const isOld = G.preRevealedMines.has(k);
          const centerX = sx + cellSize / 2;
          const centerY = sy + cellSize / 2;
          const r = cellSize * 0.22;
          
          c.save();
          c.shadowColor = 'rgba(0,0,0,0.5)';
          c.shadowBlur = cellSize * 0.2;
          
          const grad = c.createRadialGradient(centerX - r * 0.3, centerY - r * 0.3, r * 0.1, centerX, centerY, r);
          if(isOld) {
            grad.addColorStop(0, '#5a5e76');
            grad.addColorStop(1, '#2a2e3e');
          } else {
            grad.addColorStop(0, '#ff5577');
            grad.addColorStop(1, COLORS.mine);
          }
          c.fillStyle = grad;
          c.beginPath();
          c.arc(centerX, centerY, r, 0, Math.PI * 2);
          c.fill();
          
          c.strokeStyle = isOld ? '#4a4e66' : '#ff3366';
          c.lineWidth = Math.max(1, cellSize * 0.06);
          c.lineCap = 'round';
          for(let i = 0; i < 8; i++) {
            const a = i * Math.PI / 4;
            c.beginPath();
            c.moveTo(centerX + Math.cos(a) * r * 0.85, centerY + Math.sin(a) * r * 0.85);
            c.lineTo(centerX + Math.cos(a) * r * 1.65, centerY + Math.sin(a) * r * 1.65);
            c.stroke();
          }
          
          if(!isOld) {
            c.fillStyle = 'rgba(255,255,255,0.4)';
            c.beginPath();
            c.arc(centerX - r * 0.28, centerY - r * 0.28, r * 0.27, 0, Math.PI * 2);
            c.fill();
          }
          
          c.restore();
        } else {
          const n = countMines(cx, cy);
          if(n > 0) {
            c.fillStyle = COLORS.nums[n] || '#888';
            c.font = `700 ${Math.floor(cellSize * 0.62)}px 'JetBrains Mono', monospace`;
            c.textAlign = 'center';
            c.textBaseline = 'middle';
            c.fillText(n, sx + cellSize / 2, sy + cellSize / 2 + 1);
          }
        }
      } else {
        c.fillStyle = COLORS.hidden;
        c.fillRect(sx + p, sy + p, cellSize - p * 2, cellSize - p * 2);
        
        c.fillStyle = COLORS.blight;
        const hl = Math.max(1, cellSize * 0.08);
        c.fillRect(sx + p, sy + p, cellSize - p * 2, hl);
        c.fillRect(sx + p, sy + p, hl, cellSize - p * 2);
        
        if(flagged) {
          const fcx = sx + cellSize / 2;
          const fcy = sy + cellSize / 2;
          const s = cellSize * 0.28;
          const pW = Math.max(1.5, cellSize * 0.065);
          const pTop = fcy - s * 1.0;
          const pBot = fcy + s * 1.2;
          
          c.save();
          c.shadowColor = 'rgba(0,0,0,0.38)';
          c.shadowBlur = cellSize * 0.14;
          
          c.fillStyle = '#4a5280';
          c.beginPath();
          c.ellipse(fcx, pBot, s * 0.65, s * 0.18, 0, 0, Math.PI * 2);
          c.fill();
          
          const pg = c.createLinearGradient(fcx, 0, fcx + pW * 3, 0);
          pg.addColorStop(0, '#6a7090');
          pg.addColorStop(1, '#b0b8d0');
          c.fillStyle = pg;
          c.beginPath();
          if(c.roundRect) {
            c.roundRect(fcx - pW / 2, pTop, pW, pBot - pTop, pW / 2);
          } else {
            c.rect(fcx - pW / 2, pTop, pW, pBot - pTop);
          }
          c.fill();
          
          const fg = c.createLinearGradient(fcx, pTop, fcx + s * 1.5, pTop + s * 0.9);
          fg.addColorStop(0, '#ff2d6b');
          fg.addColorStop(1, '#ff7a2d');
          c.fillStyle = fg;
          c.beginPath();
          c.moveTo(fcx, pTop);
          c.lineTo(fcx + s * 1.5, pTop + s * 0.55);
          c.lineTo(fcx, pTop + s * 1.1);
          c.closePath();
          c.fill();
          
          c.fillStyle = 'rgba(255,255,255,0.18)';
          c.beginPath();
          c.moveTo(fcx, pTop);
          c.lineTo(fcx + s * 1.5, pTop + s * 0.55);
          c.lineTo(fcx, pTop + s * 0.28);
          c.closePath();
          c.fill();
          
          c.restore();
        }
      }
    }
  }
  
  tempCanvas.toBlob(blob => {
    if(!blob) {
      toast('error', 'Erreur d\'export', 'Impossible de cr√©er l\'image');
      return;
    }
    
    const sizeMB = (blob.size / 1048576).toFixed(2);
    if(blob.size > 1048576) {
      const isMobile = window.innerWidth <= 768;
      const platform = isMobile ? 'mobile' : 'PC';
      toast('info', `Image volumineuse (${sizeMB} Mo)`, `L'image est grosse, le t√©l√©chargement peut prendre quelques secondes sur ${platform}`);
    }
    
    const url = URL.createObjectURL(blob);
    
    // D√©tection iOS standalone mode
    const isIOS = /iPad|iPhone|iPod/.test(navigator.userAgent);
    const isStandalone = window.navigator.standalone === true || window.matchMedia('(display-mode: standalone)').matches;
    
    if(isIOS && isStandalone) {
      // Pour iOS en mode standalone, ouvrir dans un nouvel onglet
      const reader = new FileReader();
      reader.onloadend = function() {
        const base64data = reader.result;
        const newWindow = window.open();
        if(newWindow) {
          newWindow.document.write(`<img src="${base64data}" alt="D√©mineur" style="max-width:100%;height:auto;"><br><a download="demineur-${G.seed}-${Date.now()}.png" href="${base64data}">T√©l√©charger</a>`);
          toast('info', 'Image ouverte', 'Appuyez longtemps sur l\'image puis "Ajouter aux photos"');
        } else {
          toast('error', 'Popup bloqu√©e', 'Autorisez les popups pour t√©l√©charger');
        }
      };
      reader.readAsDataURL(blob);
    } else {
      // M√©thode normale pour desktop et mobile non-standalone
      const a = document.createElement('a');
      a.href = url;
      a.download = `demineur-${G.seed}-${Date.now()}.png`;
      document.body.appendChild(a);
      a.click();
      document.body.removeChild(a);
      setTimeout(() => URL.revokeObjectURL(url), 100);
      toast('success', 'Image export√©e !', `Image t√©l√©charg√©e (${sizeMB} Mo)`);
    }
  }, 'image/png');
}

// PANELS HTML
function panelHTML(id) {
  const isMobile = id === 'm';
  return `
    ${isMobile ? `
    <div class="panel">
      <div class="panel-title"><span class="panel-icon">üéÆ</span> Actions rapides</div>
      <div class="row-btns">
        <button class="btn btn-primary new-game-mobile-${id}"><ion-icon name="refresh-outline"></ion-icon> Nouveau</button>
        <button class="btn save-mobile-${id}"><ion-icon name="save-outline"></ion-icon> Sauvegarder</button>
      </div>
    </div>
    ` : ''}
    
    <div class="panel">
      <div class="panel-title"><span class="panel-icon">üíæ</span> Import / Export</div>
      <div class="input-group"><label>Coller un code de partie</label><input type="text" class="imp-in-${id}" placeholder="Collez le code ici..."></div>
      <div class="row-btns">
        <button class="btn btn-small imp-btn-${id}"><ion-icon name="download-outline"></ion-icon> Importer</button>
        <button class="btn btn-small exp-btn-${id}"><ion-icon name="share-outline"></ion-icon> Exporter</button>
      </div>
      <button class="btn btn-small export-img-${id}" style="width:100%;margin-top:8px;justify-content:center;"><ion-icon name="image-outline"></ion-icon> T√©l√©charger image</button>
      <div class="help-text">Le code contient la seed, les cases r√©v√©l√©es, les drapeaux et les erreurs.</div>
    </div>

    <div class="panel">
      <div class="panel-title"><span class="panel-icon">üé≤</span> Seed & G√©n√©ration</div>
      <div class="input-group"><label>Seed (vide = al√©atoire)</label><input type="text" class="seed-in-${id}" placeholder="Ex: minecraft123"></div>
      <button class="btn btn-small apply-seed-${id}" style="width:100%;margin-bottom:8px;justify-content:center;"><ion-icon name="sparkles-outline"></ion-icon> Appliquer seed</button>
      <div class="help-text">La seed g√©n√®re toujours la m√™me carte. Partagez-la avec vos amis !</div>
      <div class="input-group" style="margin-top:11px;"><label>Seed actuelle</label><input type="text" class="cur-seed" readonly style="opacity:.6;"></div>
    </div>

    <div class="panel">
      <div class="panel-title"><span class="panel-icon">‚öôÔ∏è</span> Param√®tres</div>

      <div class="toggle-group">
        <label>Sauvegarde automatique</label>
        <label class="toggle-switch">
          <input type="checkbox" class="auto-save-toggle" ${SETTINGS.autoSave?'checked':''}>
          <span class="toggle-slider"></span>
        </label>
      </div>

      <div class="toggle-group">
        <label>Notifications</label>
        <label class="toggle-switch">
          <input type="checkbox" class="notif-toggle" ${SETTINGS.notifications?'checked':''}>
          <span class="toggle-slider"></span>
        </label>
      </div>
      
      <div class="toggle-group">
        <label>D√©sactiver d√©lai d'explosion</label>
        <label class="toggle-switch">
          <input type="checkbox" class="no-delay-toggle" ${SETTINGS.noExplosionDelay?'checked':''}>
          <span class="toggle-slider"></span>
        </label>
      </div>
      <div class="help-text">Quand d√©sactiv√©, vous pouvez rejouer imm√©diatement apr√®s avoir touch√© une mine.</div>
    </div>

    <div class="panel">
      <div class="panel-title"><span class="panel-icon">‚å®</span> Raccourcis clavier</div>
      <div class="shortcut-list">
        <div class="shortcut-item"><span>R√©v√©ler case</span><span class="shortcut-key">Clic gauche</span></div>
        <div class="shortcut-item"><span>Placer drapeau</span><span class="shortcut-key">Clic droit</span></div>
        <div class="shortcut-item"><span>D√©placer vue (1)</span><span class="shortcut-key">Ctrl+Glisser</span></div>
        <div class="shortcut-item"><span>D√©placer vue (2)</span><span class="shortcut-key">Clic gauche maintenu</span></div>
        <div class="shortcut-item"><span>Zoom</span><span class="shortcut-key">Molette</span></div>
        <div class="shortcut-item"><span>Nouvelle partie</span><span class="shortcut-key">Ctrl+N</span></div>
        <div class="shortcut-item"><span>Sauvegarder</span><span class="shortcut-key">Ctrl+S</span></div>
        <div class="shortcut-item"><span>Plein √©cran</span><span class="shortcut-key">F11</span></div>
      </div>
    </div>

    <div class="tip-box">üí° <strong>Astuce :</strong> Quand un num√©ro affich√© a autant de drapeaux autour de lui que son chiffre indique, cliquez dessus pour r√©v√©ler automatiquement toutes les cases s√ªres adjacentes ‚Äî technique Chord ! Sur mobile, cliquez √† nouveau sur un bouton pour le d√©sactiver et naviguer sans risque.</div>
  `;
}

function bindPanel(id) {
  const isMobile = id === 'm';
  
  if(isMobile) {
    document.querySelector(`.new-game-mobile-${id}`).addEventListener('click', confirmNewGame);
    document.querySelector(`.save-mobile-${id}`).addEventListener('click', ()=>saveGame(true));
  }
  
  document.querySelector(`.apply-seed-${id}`).addEventListener('click',()=>{
    const v=document.querySelector(`.seed-in-${id}`).value.trim();
    confirmApplySeed(v);
  });
  document.querySelector(`.imp-btn-${id}`).addEventListener('click',()=>{
    const v=document.querySelector(`.imp-in-${id}`).value.trim();
    if(v){importGame(v);document.querySelector(`.imp-in-${id}`).value='';}
    else toast('info','Champ vide','Collez d\'abord un code de partie');
  });
  document.querySelector(`.exp-btn-${id}`).addEventListener('click',exportGame);
  document.querySelector(`.export-img-${id}`).addEventListener('click',exportImage);

  document.querySelectorAll(`.auto-save-toggle`).forEach(toggle => {
    toggle.addEventListener('change', (e) => {
      SETTINGS.autoSave = e.target.checked;
      saveSettings();
    });
  });

  document.querySelectorAll(`.notif-toggle`).forEach(toggle => {
    toggle.addEventListener('change', (e) => {
      SETTINGS.notifications = e.target.checked;
      saveSettings();
    });
  });
  
  document.querySelectorAll(`.no-delay-toggle`).forEach(toggle => {
    toggle.addEventListener('change', (e) => {
      SETTINGS.noExplosionDelay = e.target.checked;
      saveSettings();
    });
  });
}

function saveSettings() {
  try {
    localStorage.setItem('mine_settings', JSON.stringify(SETTINGS));
  } catch {}
}

function loadSettings() {
  try {
    const s = JSON.parse(localStorage.getItem('mine_settings'));
    if(s) SETTINGS = {...SETTINGS, ...s};
  } catch {}
}

function initPanels() {
  document.getElementById('sidebar-content').innerHTML=panelHTML('d');
  bindPanel('d');
  document.getElementById('mobile-sheet-body').innerHTML=panelHTML('m');
  bindPanel('m');
  document.querySelectorAll('.cur-seed').forEach(el=>el.value=G.seed||'');
}

// SIDEBAR
let sidebarOpen=false;

function toggleSidebar(force) {
  sidebarOpen=force!==undefined?force:!sidebarOpen;
  sidebar.classList.toggle('collapsed',!sidebarOpen);
}

document.getElementById('sidebar-x').addEventListener('click',()=>toggleSidebar(false));
document.getElementById('btn-desktop-params').addEventListener('click',()=>toggleSidebar());

// MOBILE SHEET
document.getElementById('btn-mobile-params').addEventListener('click',()=>mobileSheetOverlay.classList.add('show'));
document.getElementById('mobile-sheet-close').addEventListener('click',()=>mobileSheetOverlay.classList.remove('show'));
mobileSheetOverlay.addEventListener('click',e=>{if(e.target===mobileSheetOverlay)mobileSheetOverlay.classList.remove('show');});

// ZOOM BUTTONS
document.getElementById('zoom-in-btn').addEventListener('click',()=>zoom(1.25));
document.getElementById('zoom-out-btn').addEventListener('click',()=>zoom(1/1.25));
document.getElementById('zoom-reset-btn').addEventListener('click',()=>{ V.zoom=1; V.offX=V.W/2-6*CONFIG.BASE_CELL; V.offY=V.H/2-6*CONFIG.BASE_CELL; updateUI(); dirty(); });
document.getElementById('fullscreen-btn').addEventListener('click',toggleFullscreen);

// HEADER BUTTONS
document.getElementById('new-game-btn').addEventListener('click',confirmNewGame);
document.getElementById('save-btn').addEventListener('click',()=>saveGame(true));
document.getElementById('export-btn').addEventListener('click',exportGame);

// CANVAS
canvas.addEventListener('mousedown',e=>{
  V.mouseDownTime = Date.now();
  V.mouseDownX = e.clientX;
  V.mouseDownY = e.clientY;
  
  if(e.button===1||e.ctrlKey){ 
    V.panning=true;V.didPan=false;V.panSX=e.clientX;V.panSY=e.clientY;V.panOX=V.offX;V.panOY=V.offY;
    canvas.classList.add('panning');e.preventDefault(); 
  } else if(e.button===0) {
    // Clic gauche - pr√©parer potentiel drag
    V.panSX=e.clientX;V.panSY=e.clientY;V.panOX=V.offX;V.panOY=V.offY;
  }
});
canvas.addEventListener('mousemove',e=>{
  const r=canvas.getBoundingClientRect(),[cx,cy]=s2c(e.clientX-r.left,e.clientY-r.top);
  
  if(V.panning){ 
    const dx=e.clientX-V.panSX,dy=e.clientY-V.panSY; 
    if(Math.abs(dx)>2||Math.abs(dy)>2)V.didPan=true; 
    V.offX=V.panOX+dx;V.offY=V.panOY+dy;dirty(); 
  } else if(e.buttons===1 && !e.ctrlKey) {
    // Clic gauche maintenu - v√©rifier si d√©placement
    const dx=e.clientX-V.panSX,dy=e.clientY-V.panSY;
    if(Math.abs(dx)>5||Math.abs(dy)>5) {
      // Mouvement d√©tect√© - activer drag
      V.panning=true;V.didPan=true;
      canvas.classList.add('panning');
    }
  } else if(!V.hover||V.hover[0]!==cx||V.hover[1]!==cy){ 
    V.hover=[cx,cy];dirty(); 
  }
});
canvas.addEventListener('mouseup',()=>{V.panning=false;canvas.classList.remove('panning');});
canvas.addEventListener('mouseleave',()=>{V.panning=false;canvas.classList.remove('panning');V.hover=null;dirty();});
canvas.addEventListener('click',e=>{
  if(V.didPan){V.didPan=false;return;} 
  if(e.ctrlKey)return;
  
  // V√©rifier si c'√©tait un clic rapide (pas un drag)
  const clickDuration = Date.now() - V.mouseDownTime;
  const dx = Math.abs(e.clientX - V.mouseDownX);
  const dy = Math.abs(e.clientY - V.mouseDownY);
  
  if(clickDuration < 300 && dx < 5 && dy < 5) {
    const r=canvas.getBoundingClientRect(),[cx,cy]=s2c(e.clientX-r.left,e.clientY-r.top); 
    reveal(cx,cy);
  }
});
canvas.addEventListener('contextmenu',e=>{
  e.preventDefault(); 
  if(V.didPan){V.didPan=false;return;}
  const r=canvas.getBoundingClientRect(),[cx,cy]=s2c(e.clientX-r.left,e.clientY-r.top); 
  flag(cx,cy);
});
canvas.addEventListener('wheel',e=>{
  e.preventDefault(); const r=canvas.getBoundingClientRect();
  zoom(e.deltaY<0?1.15:1/1.15,e.clientX-r.left,e.clientY-r.top);
},{passive:false});

// TOUCH
let ltd=null,ltcx,ltcy;
canvas.addEventListener('touchstart',e=>{
  e.preventDefault();
  if(e.touches.length===2){ 
    ltd=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); 
    ltcx=(e.touches[0].clientX+e.touches[1].clientX)/2; 
    ltcy=(e.touches[0].clientY+e.touches[1].clientY)/2; 
  }
  else { 
    V.panning=true;V.didPan=false;V.panSX=e.touches[0].clientX;V.panSY=e.touches[0].clientY;V.panOX=V.offX;V.panOY=V.offY;ltd=null; 
  }
},{passive:false});
canvas.addEventListener('touchmove',e=>{
  e.preventDefault();
  if(e.touches.length===2&&ltd){ 
    const d=Math.hypot(e.touches[0].clientX-e.touches[1].clientX,e.touches[0].clientY-e.touches[1].clientY); 
    const cx=(e.touches[0].clientX+e.touches[1].clientX)/2,cy=(e.touches[0].clientY+e.touches[1].clientY)/2; 
    const r=canvas.getBoundingClientRect(); 
    zoom(d/ltd,cx-r.left,cy-r.top); 
    V.offX+=cx-ltcx;V.offY+=cy-ltcy;ltd=d;ltcx=cx;ltcy=cy;dirty(); 
  }
  else if(e.touches.length===1&&V.panning){ 
    const dx=e.touches[0].clientX-V.panSX,dy=e.touches[0].clientY-V.panSY; 
    if(Math.abs(dx)>2||Math.abs(dy)>2)V.didPan=true; 
    V.offX=V.panOX+dx;V.offY=V.panOY+dy;dirty(); 
  }
},{passive:false});
canvas.addEventListener('touchend',e=>{
  e.preventDefault();
  if(e.changedTouches.length===1&&!V.didPan&&!e.touches.length){ 
    const t=e.changedTouches[0],r=canvas.getBoundingClientRect(),[cx,cy]=s2c(t.clientX-r.left,t.clientY-r.top);
    if(G.mobileMode==='reveal') reveal(cx,cy);
    else if(G.mobileMode==='flag') flag(cx,cy);
    // Si neutral, ne rien faire
  }
  V.panning=false;V.didPan=false;ltd=null;
},{passive:false});

function updateMobileButtons() {
  const revealBtn = document.getElementById('mobile-reveal');
  const flagBtn = document.getElementById('mobile-flag');
  
  revealBtn.classList.remove('active');
  flagBtn.classList.remove('active');
  
  if(G.mobileMode === 'reveal') revealBtn.classList.add('active');
  else if(G.mobileMode === 'flag') flagBtn.classList.add('active');
}

document.getElementById('mobile-reveal').addEventListener('click',()=>{
  if(G.mobileMode === 'reveal') {
    G.mobileMode = 'neutral'; // D√©sactiver
  } else {
    G.mobileMode = 'reveal';
  }
  updateMobileButtons();
});

document.getElementById('mobile-flag').addEventListener('click',()=>{
  if(G.mobileMode === 'flag') {
    G.mobileMode = 'neutral'; // D√©sactiver
  } else {
    G.mobileMode = 'flag';
  }
  updateMobileButtons();
});

modalOverlay.addEventListener('click',e=>{if(e.target===modalOverlay)modalOverlay.classList.remove('show');});

// KEYBOARD
document.addEventListener('keydown',e=>{
  if(e.ctrlKey&&e.key==='n'){e.preventDefault();confirmNewGame();}
  if(e.ctrlKey&&e.key==='s'){e.preventDefault();saveGame(true);}
});

// RESIZE & INIT
function resize() {
  const r=canvasWrap.getBoundingClientRect();
  const nW=Math.floor(r.width),nH=Math.floor(r.height);
  if(nW===V.W&&nH===V.H) return;
  const fx=V.W?V.offX/V.W:0.5,fy=V.H?V.offY/V.H:0.5;
  V.W=canvas.width=nW;V.H=canvas.height=nH;V.offX=fx*nW;V.offY=fy*nH;dirty();
}
new ResizeObserver(resize).observe(canvasWrap);

setInterval(()=>{if(SETTINGS.autoSave && G.revealedCount>0)saveGame();},CONFIG.AUTO_SAVE);

window.addEventListener('load',()=>{
  const headerHeight = document.getElementById('header').offsetHeight;
  document.documentElement.style.setProperty('--header-h', headerHeight + 'px');
  
  const r=canvasWrap.getBoundingClientRect();
  V.W=canvas.width=Math.floor(r.width);V.H=canvas.height=Math.floor(r.height);
  initBg(); loadSettings(); initPanels();
  if(!loadGame()) newGame();
  dirty();
  
  // Initialiser les boutons mobiles
  updateMobileButtons();
  
  window.addEventListener('resize',()=>{
    bgCanvas.width=window.innerWidth;bgCanvas.height=window.innerHeight;
    const h = document.getElementById('header').offsetHeight;
    document.documentElement.style.setProperty('--header-h', h + 'px');
  });
});
</script>
</body>
</html>
